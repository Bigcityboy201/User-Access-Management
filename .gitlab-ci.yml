stages:
  - build
  - test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  COMPOSE_PROJECT_NAME: user-access-management
  # Sửa lại tên biến để khớp với lỗi Spring tìm không thấy
  SPRING_DATASOURCE_URL: "jdbc:postgresql://localhost:5432/auth-service"
  SPRING_DATASOURCE_USERNAME: "postgres"
  SPRING_DATASOURCE_PASSWORD: "quangtruong1"
  JWT_SECRET: "404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970"
  KAFKA_SERVER: "localhost:9092"
  SPRING_PROFILES_ACTIVE: "docker" # Đổi thành docker vì bạn đang chạy deploy qua docker-compose

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .m2/repository/

# ================= BUILD =================
build_job:
  stage: build
  tags:
    - local
  script:
    - echo "===== CLEANING OLD DOCKER IMAGES TO FREE SPACE ====="
    - docker system prune -f   # Dọn dẹp ổ đĩa để tránh lỗi "Not enough space"
    - echo "===== BUILD PROJECT ====="
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - "auth-service/target/*.jar"
      - "user-service/target/*.jar"

# ================= TEST =================
test_job:
  stage: test
  tags:
    - local
  script:
    - echo "===== RUN TESTS ====="
    - mvn test

# ================= DEPLOY =================
deploy_job:
  stage: deploy
  tags:
    - local
  only:
    - main
  script:
    - echo "===== SETUP DOCKER ENVIRONMENT ====="
    - docker --version
    - docker-compose --version

    - echo "===== STOPPING EXISTING CONTAINERS ====="
    # PowerShell không hiểu "|| true". Ta dùng cấu trúc Try/Catch hoặc lờ đi
    - docker-compose down

    - echo "===== BUILDING AND STARTING CONTAINERS ====="
    - docker-compose up -d --build

    - echo "===== CHECKING CONTAINER STATUS ====="
    - docker ps -a

    - echo "===== RUNNING HEALTH CHECKS ====="
    # Sử dụng PowerShell Invoke-RestMethod thay cho curl nếu curl không có sẵn
    - sleep 20
    - docker-compose ps